/******************************************************************************
 *
 * Copyright (C) 2018 Xilinx, Inc.  All rights reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * Use of the Software is limited solely to applications:
 * (a) running on a Xilinx device, or
 * (b) that interact with a Xilinx device through a bus or interconnect.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * XILINX  BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * Except as contained in this notice, the name of the Xilinx shall not be used
 * in advertising or otherwise to promote the sale, use or other dealings in
 * this Software without prior written authorization from Xilinx.
 *
 ******************************************************************************/

/***************************** Include Files *********************************/
#include <stdio.h>
#include <stdlib.h>
#include "xrfdc.h"
#include "rfdc_interface.h"
#include "data_interface.h"
#include "clock_interface.h"
#include "rfdc_functions.h"

/************************** Constant Definitions *****************************/
#define RFDC_DEVICE_ID  XPAR_XRFDC_0_DEVICE_ID

/* static sinewave data with 1300 MHz freq */
const signed short sine_wave[1024] = { 32767,-15623,-17869,32663,-13279,-20000,
									32351,-10849,-22005,31833,-8351,-23870,
									31113,-5800,-25582,30195,-3212,-27133,
									29085,-603,-28510,27790,2009,-29706,
									26319,4609,-30714,24680,7179,-31526,
									22884,9704,-32137,20942,12167,-32545,
									18868,14553,-32745,16673,16846,-32737,
									14372,19032,-32521,11980,21096,-32098,
									9512,23027,-31470,6983,24811,-30643,
									4410,26438,-29621,1809,27896,-28411,
									-804,29177,-27019,-3412,30273,-25456,
									-5998,31176,-23731,-8545,31880,-21856,
									-11039,32382,-19841,-13462,32678,-17700,
									-15800,32766,-15446,-18037,32646,-13094,
									-20159,32318,-10659,-22154,31785,-8157,
									-24007,31050,-5602,-25708,30117,-3012,
									-27245,28992,-402,-28609,27683,2210,
									-29791,26198,4808,-30783,24547,7375,
									-31580,22739,9896,-32176,20787,12353,
									-32567,18703,14732,-32752,16499,17018,
									-32728,14191,19195,-32495,11793,21250,
									-32057,9319,23170,-31414,6786,24942,
									-30571,4210,26556,-29534,1608,28001,
									-28310,-1005,29268,-26905,-3612,30349,
									-25329,-6195,31237,-23592,-8739,31926,
									-21705,-11228,32412,-19680,-13645,32692,
									-17530,-15976,32765,-15269,-18204,32628,
									-12910,-20317,32285,-10469,-22301,31736,
									-7962,-24143,30985,-5404,-25832,30037,
									-2811,-27356,28898,-201,-28706,27575,
									2410,-29874,26077,5007,-30852,24413,
									7571,-31633,22594,10087,-32213,20631,
									12539,-32589,18537,14912,-32757,16325,
									17189,-32717,14010,19357,-32469,11605,
									21403,-32014,9126,23311,-31356,6590,
									25072,-30498,4011,26674,-29447,1407,
									28105,-28208,-1206,29358,-26790,-3811,
									30424,-25201,-6393,31297,-23452,-8933,
									31971,-21554,-11417,32441,-19519,-13828,
									32705,-17360,-16151,32761,-15090,-18371,
									32609,-12725,-20475,32250,-10278,-22448,
									31685,-7767,-24279,30919,-5205,-25955,
									29956,-2611,-27466,28803,0,-28803,
									27466,2611,-29956,25955,5205,-30919,
									24279,7767,-31685,22448,10278,-32250,
									20475,12725,-32609,18371,15090,-32761,
									16151,17360,-32705,13828,19519,-32441,
									11417,21554,-31971,8933,23452,-31297,
									6393,25201,-30424,3811,26790,-29358,
									1206,28208,-28105,-1407,29447,-26674,
									-4011,30498,-25072,-6590,31356,-23311,
									-9126,32014,-21403,-11605,32469,-19357,
									-14010,32717,-17189,-16325,32757,-14912,
									-18537,32589,-12539,-20631,32213,-10087,
									-22594,31633,-7571,-24413,30852,-5007,
									-26077,29874,-2410,-27575,28706,201,
									-28898,27356,2811,-30037,25832,5404,
									-30985,24143,7962,-31736,22301,10469,
									-32285,20317,12910,-32628,18204,15269,
									-32765,15976,17530,-32692,13645,19680,
									-32412,11228,21705,-31926,8739,23592,
									-31237,6195,25329,-30349,3612,26905,
									-29268,1005,28310,-28001,-1608,29534,
									-26556,-4210,30571,-24942,-6786,31414,
									-23170,-9319,32057,-21250,-11793,32495,
									-19195,-14191,32728,-17018,-16499,32752,
									-14732,-18703,32567,-12353,-20787,32176,
									-9896,-22739,31580,-7375,-24547,30783,
									-4808,-26198,29791,-2210,-27683,28609,
									402,-28992,27245,3012,-30117,25708,
									5602,-31050,24007,8157,-31785,22154,
									10659,-32318,20159,13094,-32646,18037,
									15446,-32766,15800,17700,-32678,13462,
									19841,-32382,11039,21856,-31880,8545,
									23731,-31176,5998,25456,-30273,3412,
									27019,-29177,804,28411,-27896,-1809,
									29621,-26438,-4410,30643,-24811,-6983,
									31470,-23027,-9512,32098,-21096,-11980,
									32521,-19032,-14372,32737,-16846,-16673,
									32745,-14553,-18868,32545,-12167,-20942,
									32137,-9704,-22884,31526,-7179,-24680,
									30714,-4609,-26319,29706,-2009,-27790,
									28510,603,-29085,27133,3212,-30195,
									25582,5800,-31113,23870,8351,-31833,
									22005,10849,-32351,20000,13279,-32663,
									17869,15623,-32767,15623,17869,-32663,
									13279,20000,-32351,10849,22005,-31833,
									8351,23870,-31113,5800,25582,-30195,
									3212,27133,-29085,603,28510,-27790,
									-2009,29706,-26319,-4609,30714,-24680,
									-7179,31526,-22884,-9704,32137,-20942,
									-12167,32545,-18868,-14553,32745,-16673,
									-16846,32737,-14372,-19032,32521,-11980,
									-21096,32098,-9512,-23027,31470,-6983,
									-24811,30643,-4410,-26438,29621,-1809,
									-27896,28411,804,-29177,27019,3412,
									-30273,25456,5998,-31176,23731,8545,
									-31880,21856,11039,-32382,19841,13462,
									-32678,17700,15800,-32766,15446,18037,
									-32646,13094,20159,-32318,10659,22154,
									-31785,8157,24007,-31050,5602,25708,
									-30117,3012,27245,-28992,402,28609,
									-27683,-2210,29791,-26198,-4808,30783,
									-24547,-7375,31580,-22739,-9896,32176,
									-20787,-12353,32567,-18703,-14732,32752,
									-16499,-17018,32728,-14191,-19195,32495,
									-11793,-21250,32057,-9319,-23170,31414,
									-6786,-24942,30571,-4210,-26556,29534,
									-1608,-28001,28310,1005,-29268,26905,
									3612,-30349,25329,6195,-31237,23592,
									8739,-31926,21705,11228,-32412,19680,
									13645,-32692,17530,15976,-32765,15269,
									18204,-32628,12910,20317,-32285,10469,
									22301,-31736,7962,24143,-30985,5404,
									25832,-30037,2811,27356,-28898,201,
									28706,-27575,-2410,29874,-26077,-5007,
									30852,-24413,-7571,31633,-22594,-10087,
									32213,-20631,-12539,32589,-18537,-14912,
									32757,-16325,-17189,32717,-14010,-19357,
									32469,-11605,-21403,32014,-9126,-23311,
									31356,-6590,-25072,30498,-4011,-26674,
									29447,-1407,-28105,28208,1206,-29358,
									26790,3811,-30424,25201,6393,-31297,
									23452,8933,-31971,21554,11417,-32441,
									19519,13828,-32705,17360,16151,-32761,
									15090,18371,-32609,12725,20475,-32250,
									10278,22448,-31685,7767,24279,-30919,
									5205,25955,-29956,2611,27466,-28803,
									0,28803,-27466,-2611,29956,-25955,
									-5205,30919,-24279,-7767,31685,-22448,
									-10278,32250,-20475,-12725,32609,-18371,
									-15090,32761,-16151,-17360,32705,-13828,
									-19519,32441,-11417,-21554,31971,-8933,
									-23452,31297,-6393,-25201,30424,-3811,
									-26790,29358,-1206,-28208,28105,1407,
									-29447,26674,4011,-30498,25072,6590,
									-31356,23311,9126,-32014,21403,11605,
									-32469,19357,14010,-32717,17189,16325,
									-32757,14912,18537,-32589,12539,20631,
									-32213,10087,22594,-31633,7571,24413,
									-30852,5007,26077,-29874,2410,27575,
									-28706,-201,28898,-27356,-2811,30037,
									-25832,-5404,30985,-24143,-7962,31736,
									-22301,-10469,32285,-20317,-12910,32628,
									-18204,-15269,32765,-15976,-17530,32692,
									-13645,-19680,32412,-11228,-21705,31926,
									-8739,-23592,31237,-6195,-25329,30349,
									-3612,-26905,29268,-1005,-28310,28001,
									1608,-29534,26556,4210,-30571,24942,
									6786,-31414,23170,9319,-32057,21250,
									11793,-32495,19195,14191,-32728,17018,
									16499,-32752,14732,18703,-32567,12353,
									20787,-32176,9896,22739,-31580,7375,
									24547,-30783,4808,26198,-29791,2210,
									27683,-28609,-402,28992,-27245,-3012,
									30117,-25708,-5602,31050,-24007,-8157,
									31785,-22154,-10659,32318,-20159,-13094,
									32646,-18037,-15446,32766,-15800,-17700,
									32678,-13462,-19841,32382,-11039,-21856,
									31880,-8545,-23731,31176,-5998,-25456,
									30273,-3412,-27019,29177,-804,-28411,
									27896,1809,-29621,26438,4410,-30643,
									24811,6983,-31470,23027,9512,-32098,
									21096,11980,-32521,19032,14372,-32737,
									16846,16673,-32745,14553,18868,-32545,
									12167,20942,-32137,9704,22884,-31526,
									7179,24680,-30714,4609,26319,-29706,
									2009,27790,-28510,-603,29085,-27133,
									-3212,30195,-25582,-5800,31113,-23870,
									-8351,31833,-22005,-10849,32351,-20000,
									-13279,32663,-17869,-15623 };


/**************************** Type Definitions *******************************/

/***************** Macros (Inline Functions) Definitions *********************/

/************************** Variable Definitions *****************************/

/************************** Function Prototypes ******************************/

void clean_stdin(void)
{
	int c;
	do {
		c = getchar();
	} while (c != '\n' && c != EOF);
}

int main()
{
	int ret;
	char ch;
	unsigned int lmk_offset, lmx_offset;
	int tile_id, block_id;

	/* initialize RFDC instent*/
	ret = rfdc_inst_init(RFDC_DEVICE_ID);
	if(ret != XRFDC_SUCCESS) {
		printf("Failed to initilize RFDC\n");
		return -1;
	}

	/* configure LMX and LMK clock */
	ret = initRFclock(LMK04208_12M8_3072M_122M88_REVAB, DAC_245_76_MHZ,
												DAC_245_76_MHZ, ADC_245_76_MHZ);
	if(ret != SUCCESS){
		printf("Unable to configure RF clocks\n");
		return ret;
	}

	ret = init_mem();
	if(ret) {
		printf("Unsable to initialise memory\n");
		return FAIL;
	}

	/* initialise the gpio's for data path */
	ret = init_gpio();
	if(ret) {
		printf("Unsable to initialise gpio's\n");
		goto err;
	}

	printf("Please enter DAC tile ID:");
	scanf("%d", &tile_id);
	
	printf("Please enter DAC block ID:");
	scanf("%d", &block_id);
	
	clean_stdin();

	if((tile_id >= DAC_MAX_TILE) || (block_id >= DAC_MAX_BLOCK)) {
		printf("Invaild pair of Tile ID and Block ID entered\n");
		goto err;
	}

	/* write sampels to RFDC using DMA */
	ret= WriteDataToMemory(sine_wave, tile_id, block_id,
									1024 * sizeof(signed short));
	if(ret != 0) {
		printf("Failed to write data to DAC. Error: %d\n", ret);
		goto err;
	}

	printf("static sinewave with 1300 MHz freq is generated on tile: %d, block %d\n", tile_id, block_id);

again:
	printf("\n\nPress Enter for Interpolation by 2X\n");
	ch = fgetc(stdin);

	if (ch == '\n') {
		/* set interpolation for tile 1 block 0*/
		ret = SetInterpolationFactor(tile_id, block_id);
		if(ret != SUCCESS)
			printf("Failed to set interpolation: %d\n", ret);
	} else {
		goto again;
	}

here:
	printf("Press Enter to stop data samples and exit\n");
	ch = fgetc(stdin);

	if(ch == '\n') {
		/* stop DMA to sending data */
		ret = disable_mem();
		if(ret != SUCCESS) {
			printf("Failed to disable data path. Error: %d\n", ret);
		}
	} else {
		goto here;
	}

	return SUCCESS;

err:
	ret = disable_mem();
	if(ret != SUCCESS) {
		printf("Failed to disable data path. Error: %d\n", ret);
	}
	return FAIL;
}

